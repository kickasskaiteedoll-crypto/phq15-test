<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血管外科身心健康评估系统</title>
    <script src="https://cdn.jsdelivr.net/npm/bmob.js-sdk-v4@4.0.0/dist/Bmob-4.0.0.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3; 
            --accent-color: #00a8e8;
            --bg-color: #f0f4f8;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.06);
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: #333; line-height: 1.6; }
        
        /* 顶部 Banner */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white; padding: 30px 20px; text-align: center;
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,86,179,0.3);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }
        .header p { margin-top: 10px; opacity: 0.9; font-size: 14px; }

        .container { max-width: 600px; margin: -20px auto 30px auto; padding: 0 15px; position: relative; z-index: 10; }
        
        /* 卡片通用样式 */
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--card-shadow); border-top: 4px solid transparent; }
        .card-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; }
        .card-title::before { content: ''; display: inline-block; width: 4px; height: 18px; background-color: var(--primary-color); margin-right: 10px; border-radius: 2px; }

        /* 表单样式 */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: #555; }
        .sub-label { font-size: 12px; color: #888; margin-bottom: 8px; font-weight: normal; }
        
        input[type="text"], input[type="number"], input[type="tel"], select {
            width: 100%; padding: 12px; border: 1px solid #e1e4e8; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; transition: border 0.3s; background: #fafafa;
        }
        input:focus { border-color: var(--accent-color); background: white; outline: none; }

        /* 选项样式 */
        .radio-group-vertical { display: flex; flex-direction: column; gap: 10px; }
        .radio-option {
            display: flex; align-items: center; padding: 10px 15px; 
            border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        .radio-option:hover { background-color: #f8fbff; border-color: var(--accent-color); }
        .radio-option input { margin-right: 12px; transform: scale(1.2); }

        /* PHQ-15 题目样式 - 修复版 */
        .phq-item { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .phq-item:last-child { border-bottom: none; }
        .phq-text { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
        .phq-desc { font-size: 13px; color: #7f8c8d; margin-bottom: 12px; }
        
        .phq-options { display: flex; gap: 8px; }
        .phq-btn {
            flex: 1; text-align: center; padding: 12px 2px; border: 1px solid #e0e0e0;
            border-radius: 6px; font-size: 14px; cursor: pointer; background: white; color: #666;
            transition: all 0.2s ease;
        }
        /* 选中状态 - 强制样式 */
        .phq-btn.active { 
            background-color: var(--primary-color) !important; 
            color: white !important; 
            border-color: var(--primary-color) !important; 
            font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,86,179,0.2);
        }

        /* 提交按钮 */
        .submit-btn {
            width: 100%; background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white; padding: 16px; border: none; border-radius: 30px; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0, 86, 179, 0.3); margin-top: 10px;
        }
        .submit-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* 结果页 */
        #result-section { display: none; text-align: center; padding-top: 40px; }
        .score-circle {
            width: 120px; height: 120px; background: white; border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin: 0 auto 20px; border: 6px solid var(--primary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .score-num { font-size: 42px; font-weight: bold; color: var(--primary-color); line-height: 1; }
        .score-label { font-size: 12px; color: #999; margin-top: 5px; }
        .result-box { text-align: left; background: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="header">
    <h1>身心健康综合评估</h1>
    <p>血管外科 · 辅助诊疗系统</p>
</div>

<div class="container" id="main-form">
    
    <div class="card" style="border-top-color: #3498db;">
        <div class="card-title">1. 基本信息</div>
        <div class="form-group">
            <label>姓名</label>
            <input type="text" id="username" placeholder="请输入您的姓名">
        </div>
        <div class="form-group" style="display: flex; gap: 15px;">
            <div style="flex:1">
                <label>年龄</label>
                <input type="number" id="age" placeholder="岁">
            </div>
            <div style="flex:1">
                <label>性别</label>
                <select id="gender">
                    <option value="male">男</option>
                    <option value="female">女</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>联系电话</label>
            <div class="sub-label">仅用于医生回访，我们将严格保密</div>
            <input type="tel" id="contact" placeholder="请输入手机号码">
        </div>
    </div>

    <div class="card" style="border-top-color: #e67e22;">
        <div class="card-title">2. 专科病史筛查</div>
        
        <div class="form-group">
            <label>Q1. 您目前是否有明确的“四肢疼痛”？</label>
            <div class="radio-group-vertical">
                <label class="radio-option"><input type="radio" name="vas_pain" value="无痛"> 无明显疼痛</label>
                <label class="radio-option"><input type="radio" name="vas_pain" value="间歇性跛行"> 走路时痛，休息缓解 (间歇性跛行)</label>
                <label class="radio-option"><input type="radio" name="vas_pain" value="静息痛"> 休息不动时也痛 (静息痛)</label>
                <label class="radio-option"><input type="radio" name="vas_pain" value="游走性疼痛"> 全身游走性/性质不定的疼痛</label>
            </div>
        </div>

        <div class="form-group">
            <label>Q2. 是否已确诊器质性血管疾病？</label>
            <div class="sub-label">如动脉硬化闭塞、深静脉血栓、静脉曲张等</div>
            <select id="vas_diagnosis">
                <option value="">请选择...</option>
                <option value="确诊阳性">是，医院已明确诊断</option>
                <option value="检查阴性">否，检查过但未发现明显血管病变</option>
                <option value="未检查">不清楚 / 尚未检查</option>
            </select>
        </div>

        <div class="form-group">
            <label>Q3. 近3年内是否有重大精神创伤？</label>
            <div class="radio-group-vertical">
                <label class="radio-option"><input type="radio" name="trauma" value="无"> 无</label>
                <label class="radio-option"><input type="radio" name="trauma" value="有"> 有</label>
            </div>
        </div>
    </div>

    <div class="card" style="border-top-color: #2ecc71;">
        <div class="card-title">3. 近4周身体困扰程度 (PHQ-15)</div>
        <p style="font-size:13px; color:#666; margin-bottom:20px;">请点击下方选项进行评分：</p>
        
        <div id="phq-list"></div>
    </div>

    <button id="submit-btn" class="submit-btn" onclick="submitData()">提交评估</button>
    <p id="status-msg" style="text-align: center; color: #999; font-size: 12px; margin-top: 15px;"></p>
</div>

<div class="container" id="result-section">
    <div class="card">
        <div class="score-circle">
            <div class="score-num" id="res-score">0</div>
            <div class="score-label">PHQ-15总分</div>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <span id="res-level" style="font-size: 20px; font-weight: bold; color: #333;"></span>
        </div>

        <div class="result-box" style="background: #f8fbff;">
            <p><strong>尊敬的 <span id="res-name"></span>：</strong></p>
            <p id="res-interpret" style="margin-bottom: 0;">结果解读加载中...</p>
        </div>
        
        <button class="submit-btn" onclick="location.reload()" style="background: #95a5a6; margin-top: 30px;">关闭 / 下一位</button>
    </div>
</div>

<script>
    // ==========================================
    // 第一步：先生成界面，防止JS报错导致页面空白
    // ==========================================
    
    // PHQ-15 题目数据
    const phqQuestions = [
        { t: "1. 胃痛或腹痛", d: "包括胃胀、胃痉挛、隐痛等" },
        { t: "2. 背痛", d: "腰背部酸痛、僵硬" },
        { t: "3. 肢体或关节痛", d: "胳膊、腿、膝盖等处疼痛" },
        { t: "4. 女性痛经/月经问题", d: "男性请选“没有”" },
        { t: "5. 头痛", d: "头部胀痛、紧箍感或偏头痛" },
        { t: "6. 胸痛", d: "胸闷、胸口疼痛" },
        { t: "7. 头晕", d: "昏沉感、天旋地转" },
        { t: "8. 晕倒 (晕厥)", d: "意识暂时丧失" },
        { t: "9. 心跳快或心慌", d: "静止时感觉心跳明显或心律不齐" },
        { t: "10. 呼吸急促", d: "气短、感觉吸不进气" },
        { t: "11. 性交疼痛或问题", d: "性生活相关的不适" },
        { t: "12. 肠道问题", d: "便秘、腹泻或大便不成形" },
        { t: "13. 消化问题", d: "恶心、胀气、消化不良" },
        { t: "14. 疲倦感", d: "精力不足、浑身没劲" },
        { t: "15. 睡眠问题", d: "入睡困难、早醒或睡得过多" }
    ];

    // 立即执行：渲染题目
    (function renderQuestions() {
        const listEl = document.getElementById('phq-list');
        if(!listEl) return;
        
        phqQuestions.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = 'phq-item';
            div.innerHTML = `
                <div class="phq-text">${q.t}</div>
                <div class="phq-desc">${q.d}</div>
                <div class="phq-options" id="q_group_${i}">
                    <div class="phq-btn" onclick="selectScore(${i}, 0, this)">没有 (0)</div>
                    <div class="phq-btn" onclick="selectScore(${i}, 1, this)">有一些 (1)</div>
                    <div class="phq-btn" onclick="selectScore(${i}, 2, this)">很严重 (2)</div>
                </div>
                <input type="hidden" id="val_${i}" value="-1">
            `;
            listEl.appendChild(div);
        });
    })();

    // 选中功能的逻辑
    function selectScore(qIndex, score, btnElement) {
        const group = document.getElementById(`q_group_${qIndex}`);
        const btns = group.getElementsByClassName('phq-btn');
        // 移除其他按钮的高亮
        for(let b of btns) b.classList.remove('active');
        // 激活当前按钮
        btnElement.classList.add('active');
        // 记录分数
        document.getElementById(`val_${qIndex}`).value = score;
    }

    // ==========================================
    // 第二步：初始化数据库 (放在最后)
    // ⚠️ 请在这里填入你的 Key
    // ==========================================
    const SECRET_KEY = "6b0b4b7f90b157fe";
    const API_KEY    = "howstheweathertd";

    let isBmobReady = false;
    try {
        if(typeof Bmob !== 'undefined' && SECRET_KEY.length > 10) {
            Bmob.initialize(SECRET_KEY, API_KEY);
            isBmobReady = true;
            console.log("Bmob SDK loaded success.");
        } else {
            console.warn("Bmob Key 未填写或SDK加载失败");
            document.getElementById('status-msg').innerText = "提示：数据库连接未配置，仅作演示模式";
        }
    } catch(e) {
        console.error("SDK Init Error:", e);
    }

    // ==========================================
    // 第三步：提交逻辑
    // ==========================================
    function getRadioValue(name) {
        const radios = document.getElementsByName(name);
        for (let r of radios) { if (r.checked) return r.value; }
        return "";
    }

    function submitData() {
        // 1. 收集数据
        const name = document.getElementById('username').value.trim();
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const contact = document.getElementById('contact').value.trim();
        
        const vasPain = getRadioValue('vas_pain');
        const vasDiagnosis = document.getElementById('vas_diagnosis').value;
        const trauma = getRadioValue('trauma');

        // 验证必填
        if(!name || !age || !contact) { alert("请填写完整的个人信息（姓名、年龄、电话）"); return; }
        if(!vasPain || !vasDiagnosis || !trauma) { alert("请完成第2部分：专科病史筛查"); return; }

        // 计算分数
        let totalScore = 0;
        let scoreDetails = [];
        for(let i=0; i<phqQuestions.length; i++) {
            const val = parseInt(document.getElementById(`val_${i}`).value);
            if(val === -1) { 
                alert(`第3部分第 ${i+1} 题未作答`); 
                // 滚动到该题位置
                document.getElementById(`q_group_${i}`).scrollIntoView({behavior: "smooth", block: "center"});
                return; 
            }
            totalScore += val;
            scoreDetails.push(val);
        }

        const btn = document.getElementById('submit-btn');
        btn.innerText = "正在提交...";
        btn.disabled = true;

        // 结果解读
        let level = "", interpret = "";
        if (totalScore <= 4) { 
            level = "无或轻微"; interpret = "躯体症状困扰极低，通常不需要临床干预。";
        } else if (totalScore <= 9) { 
            level = "轻度"; interpret = "存在轻度的躯体不适，建议保持良好的作息。";
        } else if (totalScore <= 14) { 
            level = "中度"; interpret = "存在中度的躯体症状困扰，可能会影响日常生活。";
        } else { 
            level = "重度"; interpret = "存在重度的躯体症状困扰，建议结合心理科会诊。";
        }

        // 如果数据库没准备好，直接显示结果（防卡死）
        if(!isBmobReady) {
            alert("注意：由于Key未配置或网络问题，数据将只在本地显示，无法保存到后台。");
            showResultPage(name, totalScore, level, interpret);
            return;
        }

        // 上传数据 (使用驼峰命名)
        const query = Bmob.Query('VascularPHQ');
        query.set("name", name);
        query.set("age", parseInt(age));
        query.set("gender", gender);
        query.set("contact", contact);
        query.set("vasPainType", vasPain);
        query.set("vasDiagnosis", vasDiagnosis);
        query.set("traumaHistory", trauma);
        query.set("totalScore", totalScore);
        query.set("scoreLevel", level);
        query.set("rawScores", scoreDetails.join(","));

        query.save().then(res => {
            showResultPage(name, totalScore, level, interpret);
        }).catch(err => {
            console.error(err);
            alert("数据保存失败，请检查网络。但您的评估结果如下：");
            showResultPage(name, totalScore, level, interpret);
        });
    }

    function showResultPage(name, score, level, interpret) {
        document.getElementById('main-form').style.display = 'none';
        document.querySelector('.header').style.display = 'none';
        document.getElementById('result-section').style.display = 'block';
        
        document.getElementById('res-name').innerText = name;
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-level').innerText = level;
        document.getElementById('res-interpret').innerText = interpret;
        
        const circle = document.querySelector('.score-circle');
        if(score <= 4) circle.style.borderColor = "#2ecc71";
        else if(score <= 9) circle.style.borderColor = "#f1c40f";
        else if(score <= 14) circle.style.borderColor = "#e67e22";
        else circle.style.borderColor = "#e74c3c";
        
        window.scrollTo(0, 0);
    }
</script>

</body>
</html>

